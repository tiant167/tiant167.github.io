---
layout: post
title:  "ECMAScript Module in Node.js"
date:   2022-11-09 21:35:14 +0800
tags: [Coding]
---
è‡ªä» Node.js åœ¨ 14 å’Œ 12 ç‰ˆæœ¬æ”¯æŒäº† ECMAScript Moduleï¼Œè¶Šæ¥è¶Šå¤šçš„åŒ…å¼€å§‹æ”¯æŒ ESMã€‚ESM å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°ä¸œè¥¿ï¼Œå®ƒå·²ç»æ˜¯ JavaScript å®˜æ–¹æ ‡å‡†çš„åŒ…è§„èŒƒäº†ã€‚è€Œå› ä¸ºå†å²åŸå›  Node.js ä¹‹å‰éƒ½ä½¿ç”¨ CommonJSï¼Œè€Œéšç€æ”¯æŒ ESM çš„åŒ…è¶Šæ¥è¶Šå¤šï¼Œä¸ªäººè§‰å¾— ESM ä¹‹åä¼šæˆä¸º Node.js çš„ä¸»æµåŒ…è§„èŒƒã€‚

è¿™ä¸ªæ–‡ç« ä¸»è¦ä¸¾ä¾‹äº†ä¸€äº›ä»£ç ç‰‡æ®µï¼Œå¸®åŠ©ç†è§£ ESM å’Œ CJS çš„å·®å¼‚ã€‚å…¶ä¸­ä¸å°‘å†…å®¹éƒ½æ¥è‡ªäº [Mozilla çš„è¿™ç¯‡ä»‹ç» ESM çš„æ–‡ç« ](https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/)ï¼Œæ¨èé˜…è¯»ï½

è¿™ä¸ªæ–‡ç« è®²è§£äº† ESM å’Œ CJS æ˜¯å¦‚ä½•åŠ è½½è¿è¡Œä»£ç çš„ï¼Œäº†è§£ä¸¤è€…çš„åŠ è½½è¿è¡Œæœºåˆ¶æ˜¯ææ¸…æ¥šä¸¤è€…åœ¨ä½¿ç”¨å±‚é¢å·®å¼‚çš„å¥½æ–¹æ³•ã€‚

#### CJS
CJS çš„åŠ è½½æ—¶æœºæ˜¯æ‰§è¡Œåˆ° require æ—¶ï¼Œæ¯ä¸ª require ä¾æ¬¡åŒæ­¥æ‰§è¡Œã€‚åœ¨ä¸€ä¸ªæ–‡ä»¶ç¬¬ä¸€æ¬¡åŠ è½½å®Œæˆåï¼Œmodule åŠ è½½ç»“æœä¼šè¢«ç¼“å­˜ï¼Œå†æ¬¡ require æ—¶ä¸ä¼šé‡æ–°åŠ è½½/æ‰§è¡Œç›®æ ‡æ–‡ä»¶/ä»£ç ã€‚
```javascript
// ./sayHi.cjs
'use strict';
console.log('module sayHi start loading');

module.exports.sayHi = function() {
  console.log('hi everyone');
}

console.log('module sayHi is loaded');
```
```javascript
// index.js
'use strict';
console.log('index.js starts');

// å¼•ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„æ–¹æ³•
const { hi } = require('./sayHi.cjs');
// è§¦å‘é”™è¯¯
hi();

console.log('index.js is running');
```
ä¸¾ä¸ªä¾‹å­ï¼Œ`sayHi.cjs`å¯¹å¤–è¾“å‡ºäº† sayHi æ–¹æ³•ï¼Œindex.cjs æ–¹æ³•å¼•å…¥ä½†ä½¿ç”¨äº†é”™è¯¯çš„æ–¹æ³•ã€‚æ‰§è¡Œ index.cjs å¯ä»¥å¾—åˆ°å¦‚ä¸‹è¾“å‡ºï¼š
```
# node index.js
index.js starts
module sayHi start loading
module sayHi is loaded
/Users/zhoujing.cht/Documents/workspace/playground/cjs-test1/index.cjs:7
hi();
^

TypeError: hi is not a function
at Object.<anonymous> (/Users/zhoujing.cht/Documents/workspace/playground/cjs-test1/index.cjs:7:1)
...
...
```
#### ESM
ESM åŠ è½½åˆ†ä¸ºä¸‰æ­¥ï¼šConstructionã€Instantiationã€Evaluation

- Construction é˜¶æ®µä¼šå°†æ‰€æœ‰çš„ import æ¶‰åŠåˆ°çš„ module éƒ½è¿›è¡ŒåŠ è½½ï¼Œå½¢æˆ Module Record å­˜å‚¨èµ·æ¥
- Instantiation é˜¶æ®µä¼šå°†æ‰€æœ‰ export çš„å¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†é…ä½ç½®ï¼Œå¹¶å°†å„ä¸ª module çš„ import å’Œ export è¿æ¥èµ·æ¥
- Evaluation é˜¶æ®µå°†è¿è¡Œä»£ç å¾—åˆ° export çš„å…·ä½“å€¼

è¿™ä¸‰ä¸ªé˜¶æ®µè¢«è®¾è®¡æˆå¯å¼‚æ­¥æ‰§è¡Œï¼Œé‡è¦çš„åŸå› æ˜¯å› ä¸ºåœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹ä¸‹è½½æ–‡ä»¶ä¼šå¾ˆæ…¢ï¼Œå¦‚æœæ˜¯ CJS è¿™ç§åŒæ­¥åŠ è½½çš„æœºåˆ¶ä¼šé˜»å¡ä¸»è¿›ç¨‹ï¼Œå¯¼è‡´ç½‘é¡µæ²¡æœ‰å“åº”ã€æ•´ä½“åŠ è½½ç¼“æ…¢ã€‚

æˆ‘ä»¬ç”¨ä¸Šé¢åŒæ ·çš„ä¾‹å­ï¼Œä½¿ç”¨ ESM å®ç°ï¼Œä¼šå‘ç°åœ¨æ‰§è¡Œä»»ä½•ä»£ç ä¹‹å‰ç¨‹åºå°±å·²ç»æŠ›å‡ºäº†é”™è¯¯ï¼ŒsayHi.mjs ä¸­çš„ `console.log` ä¸ä¼šè¢«æ‰§è¡Œã€‚
```javascript
// ./sayHi.mjs
console.log('module sayHi start loading');

export function sayHi () {
  console.log('hi everyone');
}

console.log('module sayHi is loaded');

```
```javascript
// index.mjs
// å¼•å…¥ä¸å­˜åœ¨çš„æ–¹æ³•
import { hi } from './sayHi.mjs'

console.log('index.js starts');

hi();

console.log('index.js is running');
```
```
# node index.mjs
file:///Users/zhoujing.cht/Documents/workspace/playground/cjs-test1/index.mjs:2
import { hi } from './sayHi.mjs'
         ^^
SyntaxError: The requested module './sayHi.mjs' does not provide an export named 'hi'
    at ModuleJob._instantiate (node:internal/modules/esm/module_job:123:21)
```
ESM è¯¦ç»†çš„åŠ è½½è¿‡ç¨‹åœ¨ Mozilla çš„æ–‡ç« ä¸­è¯´çš„å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œä¹Ÿæ²¡æœ‰å¿…è¦å†ç¿»è¯‘é‡æ–°å†™ä¸€æ¬¡ã€‚åé¢å°±é’ˆå¯¹å‡ ä¸ªç‚¹ç”¨ä¾‹å­å±•å¼€çœ‹ä¸‹ CJS å’Œ ESM çš„åŒºåˆ«ã€‚åˆ†åˆ«æ˜¯ï¼š

- å¾ªç¯ä¾èµ–
- å¼•ç”¨ vs. å¤åˆ¶
- åŒ…çš„å®‰å…¨
#### å…³äºå¾ªç¯ä¾èµ–
CJS å¾ªç¯ä¾èµ–ä½¿ç”¨ [Node.js å®˜ç½‘çš„ä¾‹å­](https://nodejs.org/api/modules.html#cycles)
```javascript
// a.js
console.log('a starting');
exports.done = false;
const b = require('./b.js');
console.log('in a, b.done = %j', b.done);
exports.done = true;
console.log('a done');
```
```javascript
// b.js
console.log('b starting');
exports.done = false;
const a = require('./a.js');
console.log('in b, a.done = %j', a.done);
exports.done = true;
console.log('b done');
```
```javascript
// main.js
console.log('main starting');
const a = require('./a.js');
const b = require('./b.js');
console.log('in main, a.done = %j, b.done = %j', a.done, b.done);
```
è¿™ä¸ªä¾‹å­é‡Œï¼Œ

1. main å¼•ç”¨äº† aï¼Œæ­¤æ—¶`a.done`æ˜¯`false`
2. a å¼•ç”¨ b åï¼Œb åˆå¼•ç”¨äº† aã€‚ä¸ºäº†é˜²æ­¢æ— é™å¾ªç¯ï¼Œä¸€ä¸ªæœªå®Œå…¨æ‰§è¡Œçš„ç»“æœè¢«è¿”å›ç»™ bï¼Œå¾—åˆ° `a.done = false`
3. b æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œa å–åˆ°`b.done`ä¸º trueï¼Œä¿®æ”¹è‡ªå·±çš„`a.done`ä¸º`true`
4. æœ€ç»ˆ main æ‰“å°ä¸¤ä¸ª module çš„`done`å‡ä¸º`true`

è¾“å‡ºç»“æœï¼š
```
# node main.js
main starting
a starting
b starting
in b, a.done = false
b done
in a, b.done = true
a done
in main, a.done = true, b.done = true
```
åŒæ ·çš„ä¾‹å­åœ¨ ESM ä¸­æ˜¯è¡Œä¸é€šçš„ï¼Œä¼šè·å¾—`ReferenceError: Cannot access 'done' before initialization`çš„é”™è¯¯ã€‚å› ä¸º module b åœ¨è¿è¡Œæ—¶ module a çš„`done`è¿˜æ²¡æœ‰è¢«èµ‹å€¼ã€‚

ä½†æ˜¯æˆ‘ä»¬ä¿®æ”¹ export çš„å†…å®¹ä¸ºå‡½æ•°ï¼Œå°±å¯ä»¥æ‰§è¡Œã€‚è¿™ä¸ªä¾‹å­é‡Œï¼Œmodule a è¾“å‡ºäº†`foo`æ–¹æ³•ï¼Œmodule b è¾“å‡ºäº†`bar`æ–¹æ³•ï¼Œä¸¤è€…äº’ç›¸å¼•ç”¨ã€‚è¿™æ˜¯å› ä¸ºä¸ºäº†æ–¹ä¾¿ Evaluation é˜¶æ®µçš„å¤„ç†ï¼Œå‡½æ•°æ–¹æ³•çš„åˆå§‹åŒ–èµ‹å€¼ä¼šåœ¨ Instantiation é˜¶æ®µå°±ä¼šå®Œæˆã€‚
```javascript
// a.mjs
import { bar } from './b.mjs';
console.log('a.mjs')
console.log(bar());
function foo() { return 'foo' }
export { foo };
```
```javascript
//b.mjs
import { foo } from './a.mjs';
console.log('b.mjs');
console.log(foo());
function bar() { return 'bar' }
export { bar };
```
```javascript
// main.mjs
console.log('main starting');
import * as a from './a.mjs';
import * as b from './b.mjs';
```
```
# node main.mjs
b.mjs
foo
a.mjs
bar
main starting
```
#### å…³äºå¼•ç”¨ä¸å¤åˆ¶
å¦å¤–ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å·®å¼‚ç‚¹æ˜¯ CJS è¾“å‡ºçš„å¯¹è±¡æ˜¯å¤åˆ¶ï¼Œè€Œ ESM è¾“å‡ºçš„å¯¹è±¡æ˜¯å¼•ç”¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œmodule a è¾“å‡ºäº†ä¸€ä¸ªæ•°å­—å’Œè‡ªå¢çš„æ–¹æ³•ã€‚module b å’Œ module c å¼•ç”¨è¿›æ¥æ‰“å°å¹¶è°ƒç”¨ä¸€æ¬¡è‡ªå¢å‡½æ•°ã€‚

åœ¨ CJS ä¸­ï¼Œå› ä¸ºæ¯ä¸ª export çš„å¯¹è±¡æ˜¯å¤åˆ¶ï¼Œæ‰€ä»¥ module b å’Œ c çš„è¾“å‡ºå€¼éƒ½æ˜¯`1`ï¼Œ`inc`ä¹‹åä¹Ÿä¸ä¼šå¢åŠ ã€‚

```javascript
// a.cjs
let a = 1;
function inc() {
  a++;
  console.log('module a, after inc a=%s', a)
}

module.exports = {
  a,
  inc
}
```
```javascript
// b.cjs
const { a, inc } = require('./a.cjs')

console.log('module b, a=%s', a)
inc();
console.log('module b, after inc, a=%s', a)
```
```javascript
// c.cjs
const { a, inc } = require('./a.cjs')

console.log('module c, a=%s', a)
inc();
console.log('module c, after inc, a=%s', a)
```
```
# require('./b.cjs')
# require('./c.cjs')

module b, a=1
module a, after inc a=2
module b, after inc, a=1
module c, a=1
module a, after inc a=3
module c, after inc, a=1
```
åŒæ ·çš„é€»è¾‘ï¼Œåœ¨ ESM ä¸­ï¼Œmodule a è¾“å‡ºçš„æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œmodule b å’Œ c éƒ½æ˜¯ä½¿ç”¨åŒä¸€ä»½å¯¹è±¡ï¼Œæ‰€ä»¥`inc`å’Œ`a`çš„å€¼éƒ½æ˜¯åŒæ—¶å¢åŠ ã€‚

```javascript
// a.mjs
export let a = 1;
export function inc() {
  a++;
  console.log('module a, after inc a=%s', a)
}
```
```javascript
// b.mjs
import { a, inc } from './a.mjs'

console.log('module b, a=%s', a)
inc();
console.log('module b, after inc, a=%s', a)
```
```javascript
//c.mjs
import { a, inc } from './a.mjs'

console.log('module c, a=%s', a)
inc();
console.log('module c, after inc, a=%s', a)
```
```
# import './b.mjs'
# import './c.mjs'

module b, a=1
module a, after inc a=2
module b, after inc, a=2
module c, a=2
module a, after inc a=3
module c, after inc, a=3
```
ä¸€ä¸ªå°çš„æ³¨æ„ç‚¹æ˜¯ CJS å¦‚æœ export çš„ a ä¸æ˜¯æ•°å­—è€Œæ˜¯ objectï¼Œé‚£å¤šä»½ export å¤åˆ¶çš„å¯¹è±¡ a è¿˜æ˜¯æŒ‡å‘åŒä¸€ä¸ª objectã€‚è¾“å‡ºçš„ç»“æœå’Œ ESM æ˜¯ä¸€æ ·çš„ã€‚
```javascript
// a.cjs
let a = { v: 1 };
function inc() {
  a.v++;
  console.log('module a, after inc a=%s', a.v)
}

module.exports = {
  a,
  inc
}
```
```javascript
// b.cjs
const { a, inc } = require('./a.cjs')

console.log('module b, a=%s', a.v)
inc();
console.log('module b, after inc, a=%s', a.v)
```
```javascript
// c.cjs
const { a, inc } = require('./a.cjs')

console.log('module c, a=%s', a.v)
inc();
console.log('module c, after inc, a=%s', a.v)
```
```
# require('./b.cjs')
# require('./c.cjs')

module b, a=1
module a, after inc a=2
module b, after inc, a=2
module c, a=2
module a, after inc a=3
module c, after inc, a=3
```
#### å…³äºå®‰å…¨
CJS è¢«è¯Ÿç—…æ¯”è¾ƒå¤šçš„ä¸€ç‚¹æ˜¯è¾“å‡ºçš„å¯¹è±¡å¯ä»¥è¢«ä»»æ„çš„ä½¿ç”¨æ–¹ç¯¡æ”¹ã€‚åœ¨å¤§å‹åº”ç”¨é‡Œï¼Œä¾èµ–çš„ä¸‰æ–¹åŒ…éå¸¸å¤šï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬éƒ½ç›¸ä¿¡è¿™äº›åŒ…æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯å…¶å®å¹¶ä¸æ˜¯ğŸ‘»

çœ‹ä¸ªå’Œä¸Šé¢ç±»ä¼¼çš„ä¾‹å­ï¼Œ
1. module a è¾“å‡ºäº†æ•°å­—`a`ä¸º`1`ï¼Œmodule b åœ¨å¼•å…¥åï¼Œå¯¹ module a export å¯¹è±¡ä¸­çš„`a`ç›´æ¥è¿›è¡Œäº†ä¿®æ”¹
2. å› ä¸º CJS module å¯¹è±¡ export çš„ç»“æœæ˜¯ç¼“å­˜èµ·æ¥çš„å¯¹è±¡ï¼ˆè¯¦è§[å®˜æ–¹æ–‡æ¡£](https://nodejs.org/api/modules.html#requirecache)ï¼‰ï¼Œåœ¨ module c å¼•å…¥ module a çš„æ—¶å€™ï¼Œç›´æ¥å¤åˆ¶äº†è¢«ä¿®æ”¹è¿‡çš„ export ç»“æœã€‚å¯¼è‡´ module c æ‹¿åˆ°çš„ç»“æœæ˜¯`boom`è€Œä¸å†æ˜¯æ•°å­—`1`

```javascript
// a.cjs
let a = 1;

module.exports = {
  a
}
```
```javascript
// b.cjs
const moduleA = require('./a.cjs')

console.log('module b, a=%s', moduleA.a)
moduleA.a = 'boom'
console.log('module b, after edit, a=%s', moduleA.a)
```
```javascript
// c.cjs
const { a } = require('./a.cjs')

console.log('module c, a=%s', a)
```
```
# require('./b.cjs')
# require('./c.cjs')

module b, a=1
module b, after edit, a=boom
module c, a=boom
```
è€Œåœ¨ ESM ä¸­ï¼Œè§„èŒƒé€šè¿‡å°† export çš„å¯¹è±¡è®¾ç½®ä¸ºåªè¯»çš„æ–¹å¼ç¦æ­¢äº†æ¨¡å—å¤–çš„ä½¿ç”¨è€…ä¿®æ”¹æ¨¡å—çš„è¾“å‡ºç»“æœã€‚

åŒæ ·çš„ä¾‹å­åœ¨è¿è¡Œåˆ°`moduleA.a = 'boom'`æ—¶ï¼ŒæŠ¥é”™ç»ˆæ­¢äº†ç¨‹åºã€‚
```javascript
// a.mjs
export let a = 1;
```
```javascript
// b.mjs
import * as moduleA from './a.mjs'

console.log('module b, a=%s', moduleA.a)
moduleA.a = 'boom'
console.log('module b, after edit, a=%s', moduleA.a)
```
```javascript
// c.mjs
import { a } from './a.mjs'

console.log('module c, a=%s', a)
```
```
# import './b.mjs'
# import './c.mjs'

module b, a=1
file:///Users/zhoujing.cht/Documents/workspace/playground/cjs-test1/b.mjs:34
moduleA.a = 'boom'
          ^

TypeError: Cannot assign to read only property 'a' of object '[object Module]'
```
ä½†å¦‚æœ a æ˜¯å¯¹è±¡ï¼Œç›´æ¥ä¿®æ”¹ a å¯¹è±¡å†…çš„å€¼ä»ç„¶æ˜¯å¯ä»¥æˆåŠŸçš„ã€‚å’Œä¹‹å‰çš„æ¯”è¾ƒç±»ä¼¼ï¼Œä¸å†ä¸¾ä¾‹å­äº†ã€‚

#### å…¶ä»–å‚è€ƒ
[https://blog.logrocket.com/commonjs-vs-es-modules-node-js/](https://blog.logrocket.com/commonjs-vs-es-modules-node-js/)

[https://webreflection.medium.com/cjs-vs-esm-5f8b90a4511a](https://webreflection.medium.com/cjs-vs-esm-5f8b90a4511a)
